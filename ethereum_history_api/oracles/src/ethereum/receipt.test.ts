import { describe, expect, it } from 'vitest';
import { encodeReceipt, logToRlp, txTypeToHex } from './receipt.js';
import { Log, TransactionReceipt } from 'viem';

// TODO: Use JS fixtures when ready
const CHAINLINK_TRANSFER_LOG = {
  blockHash: '0x7306134ec4774f63f023a641c25fcf11f9625cfe5dcb1c29cdd13732e4a583aa',
  address: '0x514910771af9ca656af840dff83e8264ecf986ca',
  logIndex: 21,
  data: '0x00000000000000000000000000000000000000000000003f44127fb43fa10000',
  removed: false,
  topics: [
    '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef',
    '0x000000000000000000000000fa4d81487ece32e95ae2bee5fc860f189fe163d8',
    '0x000000000000000000000000125f660239707c9de3462d3fa633f2723ad0b884'
  ],
  blockNumber: 19432673n,
  transactionIndex: 8,
  transactionHash: '0x98e19df80eb8feae436896cc7cc6d4a97818e6010b56a249352b9ac2caf0d573'
} as Log;

// TODO: Use JS fixtures when ready
const CHAINLINK_TRANSFER_RECEIPT = {
  transactionHash: '0x98e19df80eb8feae436896cc7cc6d4a97818e6010b56a249352b9ac2caf0d573',
  blockHash: '0x7306134ec4774f63f023a641c25fcf11f9625cfe5dcb1c29cdd13732e4a583aa',
  blockNumber: 19432673n,
  logsBloom:
    '0x00000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001040000008000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000010000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000400000000000000004000000000000100000000000000000000000000000000000000000000000000000000000000000000000000002000000',
  gasUsed: 34989n,
  contractAddress: null,
  cumulativeGasUsed: 661473n,
  transactionIndex: 8,
  from: '0xfa4d81487ece32e95ae2bee5fc860f189fe163d8',
  to: '0x514910771af9ca656af840dff83e8264ecf986ca',
  type: 'eip1559',
  effectiveGasPrice: 52868291457n,
  logs: [CHAINLINK_TRANSFER_LOG],
  status: 'success'
} as TransactionReceipt;

describe('logToRlp', () => {
  it(`log`, () => {
    expect(logToRlp(CHAINLINK_TRANSFER_LOG)).toEqual([
      '0x514910771af9ca656af840dff83e8264ecf986ca',
      [
        '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef',
        '0x000000000000000000000000fa4d81487ece32e95ae2bee5fc860f189fe163d8',
        '0x000000000000000000000000125f660239707c9de3462d3fa633f2723ad0b884'
      ],
      '0x00000000000000000000000000000000000000000000003f44127fb43fa10000'
    ]);
  });
});

describe('txTypeToHex', () => {
  it(`legacy`, () => {
    expect(txTypeToHex('legacy')).toEqual('0x00');
  });
  it(`eip155`, () => {
    expect(txTypeToHex('eip155')).toEqual('0x00');
  });
  it(`eip2930`, () => {
    expect(txTypeToHex('eip2930')).toEqual('0x01');
  });
  it(`eip1559`, () => {
    expect(txTypeToHex('eip1559')).toEqual('0x02');
  });
  it(`eip4844`, () => {
    expect(txTypeToHex('eip4844')).toEqual('0x03');
  });
  it(`unknown`, () => {
    expect(() => txTypeToHex('unknown')).toThrowError(`Unknown transaction type: unknown`);
  });
});

describe('encodeReceipt', () => {
  it(`receipt`, () => {
    expect(encodeReceipt(CHAINLINK_TRANSFER_RECEIPT)).toEqual(
      '0x02f901a701830a17e1b9010000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001040000008000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000010000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000400000000000000004000000000000100000000000000000000000000000000000000000000000000000000000000000000000000002000000f89df89b94514910771af9ca656af840dff83e8264ecf986caf863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000fa4d81487ece32e95ae2bee5fc860f189fe163d8a0000000000000000000000000125f660239707c9de3462d3fa633f2723ad0b884a000000000000000000000000000000000000000000000003f44127fb43fa10000'
    );
  });
});
